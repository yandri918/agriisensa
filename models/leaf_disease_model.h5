# create_correct_model.py
import tensorflow as tf
from tensorflow.keras.applications import MobileNetV2
from tensorflow.keras.layers import Dense, GlobalAveragePooling2D
from tensorflow.keras.models import Model
import numpy as np

def create_proper_model():
    """
    Membuat model yang benar untuk deteksi penyakit daun
    """
    try:
        # Load base model dengan parameter yang benar
        base_model = MobileNetV2(
            weights='imagenet',
            include_top=False,
            input_shape=(224, 224, 3)
        )
        
        # Freeze base model
        base_model.trainable = False
        
        # Tambahkan layer kustom
        x = base_model.output
        x = GlobalAveragePooling2D()(x)
        x = tf.keras.layers.Dropout(0.2)(x)
        predictions = Dense(5, activation='softmax')(x)  # 5 kelas penyakit
        
        model = Model(inputs=base_model.input, outputs=predictions)
        
        # Compile model
        model.compile(
            optimizer=tf.keras.optimizers.Adam(learning_rate=0.001),
            loss='categorical_crossentropy',
            metrics=['accuracy']
        )
        
        # Simpan model
        model.save('models/leaf_disease_model.h5')
        print("‚úÖ Model deteksi penyakit berhasil dibuat")
        print("üìÅ File disimpan di: models/leaf_disease_model.h5")
        
        return model
        
    except Exception as e:
        print(f"‚ùå Error membuat model: {e}")
        return None

if __name__ == "__main__":
    model = create_proper_model()
    if model:
        print("üîß Model siap digunakan")
    else:
        print("‚ùå Gagal membuat model")
